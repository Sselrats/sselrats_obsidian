# LoanDoc API Specification v1

## Base URLs

- **User API**: `https://loandoc.com/api/v1`
- **Admin API**: `https://admin.loandoc.com/api/v1`

## Authentication

### User Authentication

- **Method**: Session-based (session_token in cookies or Authorization header)
- **Header**: `Authorization: Bearer {session_token}`
- **Session expires**: Configurable per login (default 30 days)

### Admin Authentication

- **Method**: JWT-based
- **Header**: `Authorization: Bearer {jwt_token}`
- **Token expires**: 24 hours (refresh token available)

---

# User API (`loandoc.com/api/v1`)

## 1. Authentication & Verification

### 1.1 Phone Verification

#### Request Verification Code

```http
POST /auth/phone/request-code
Content-Type: application/json

{
  "phone": "01012345678",
  "purpose": "phone_signup" // phone_signup, phone_login, phone_verify
}
```

**Response** (200 OK):

```json
{
  "success": true,
  "message": "인증번호가 발송되었습니다",
  "expires_in": 300
}
```

#### Verify Code

```http
POST /auth/phone/verify-code
Content-Type: application/json

{
  "phone": "01012345678",
  "code": "123456",
  "purpose": "phone_signup"
}
```

**Response** (200 OK):

```json
{
  "success": true,
  "verification_token": "temp_token_for_signup",
  "expires_at": "2025-01-02T15:30:00Z"
}
```

### 1.2 Social Login (Kakao)

#### Kakao Login Redirect

```http
GET /auth/kakao/login
```

Redirects to Kakao OAuth page.

#### Kakao Callback

```http
GET /auth/kakao/callback?code={authorization_code}&state={state}
```

**Response** (200 OK - New User):

```json
{
  "success": true,
  "is_new_user": true,
  "kakao_data": {
    "provider_id": "kakao_user_id",
    "profile_image": "https://...",
    "nickname": "홍길동"
  },
  "signup_token": "temp_token_for_signup"
}
```

**Response** (200 OK - Existing User):

```json
{
  "success": true,
  "is_new_user": false,
  "session_token": "session_token_here",
  "customer": {
    "id": 123,
    "name": "홍길동",
    "phone": "01012345678",
    "email": "user@example.com"
  }
}
```

### 1.3 Signup & Login

#### Complete Signup

```http
POST /auth/signup
Content-Type: application/json
Authorization: Bearer {verification_token or signup_token}

{
  "name": "홍길동",
  "birth_date": "1990-01-01",
  "phone": "01012345678",
  "email": "user@example.com", 
  "login_type": "email", // email, kakao
  "device_info": {
    "device_id": "uuid",
    "user_agent": "Mozilla/5.0..."
  },
  // If converting from tmp_customer_details
  "tmp_session_id": "localStorage_session_id" // optional
}
```

**Response** (201 Created):

```json
{
  "success": true,
  "session_token": "new_session_token",
  "customer": {
    "id": 123,
    "name": "홍길동",
    "phone": "01012345678",
    "email": "user@example.com",
    "profile_image_url": null
  }
}
```

#### Login (email, pw)

```http
POST /auth/login
Content-Type: application/json

{
  "email": "asdf@asdf.com",
  "password": "password",
  "device_info": {
    "device_id": "uuid",
    "user_agent": "Mozilla/5.0..."
  }
}
```

**Response** (200 OK):

```json
{
  "success": true,
  "session_token": "session_token_here",
  "customer": {
    "id": 123,
    "name": "홍길동",
    "phone": "01012345678",
    "email": "user@example.com"
  }
}
```

#### Logout

```http
POST /auth/logout
Authorization: Bearer {session_token}
```

**Response** (200 OK):

```json
{
  "success": true,
  "message": "로그아웃되었습니다"
}
```

### 1.4 Identity Verification (KCB)

#### Request KCB Verification

```http
POST /auth/cert/kcb/request
Authorization: Bearer {session_token}
Content-Type: application/json

{
  "name": "홍길동",
  "phone": "01012345678",
  "birth_date": "1990-01-01"
}
```

**Response** (200 OK):

```json
{
  "success": true,
  "redirect_url": "https://kcb.certification.url",
  "request_id": "kcb_request_id"
}
```

#### KCB Callback

```http
GET /auth/cert/kcb/callback?request_id={id}&result={result_data}
```

Server processes and updates customer record, then redirects to success/failure page.

---

## 2. Customer Profile & Details

### 2.1 Get Profile

```http
GET /customers/me
Authorization: Bearer {session_token}
```

**Response** (200 OK):

```json
{
  "customer": {
    "id": 123,
    "name": "홍길동",
    "birth_date": "1990-01-01",
    "phone": "01012345678",
    "email": "user@example.com",
    "profile_image_url": "https://...",
    "login_type": "phone"
  },
  "details": {
    "income_type": "직장인",
    "annual_income": 50000000,
    "employment_insurance": true,
    "kcb_score": 850,
    "nice_score": 900,
    "business_number": null,
    "business_start_date": null,
    "owned_properties_count": 1,
    "required_amount": 100000000
  }
}
```

### 2.2 Update Customer Details

```http
PUT /customers/me/details
Authorization: Bearer {session_token}
Content-Type: application/json

{
  "income_type": "직장인",
  "annual_income": 50000000,
  "employment_insurance": true,
  "kcb_score": 850,
  "nice_score": 900,
  "owned_properties_count": 1,
  "required_amount": 100000000
}
```

**Response** (200 OK):

```json
{
  "success": true,
  "details": {
    "id": 456,
    "customer_id": 123,
    "income_type": "직장인",
    "annual_income": 50000000,
    // ... full details
  }
}
```

### 2.3 Save Temporary Details (Before Signup)

```http
POST /customers/tmp-details
Content-Type: application/json

{
  "session_id": "localStorage_uuid",
  "income_type": "직장인",
  "annual_income": 50000000,
  "employment_insurance": true,
  "required_amount": 100000000
}
```

**Response** (201 Created):

```json
{
  "success": true,
  "tmp_id": 789,
  "session_id": "localStorage_uuid"
}
```

---

## 3. Properties & Mortgages

### 3.1 List Properties

```http
GET /properties
Authorization: Bearer {session_token}
```

**Response** (200 OK):

```json
{
  "properties": [
    {
      "id": 1,
      "customer_id": 123,
      "address_full": "서울특별시 강남구 역삼동 123-45",
      "sido": "서울특별시",
      "sigungu": "강남구",
      "dong": "역삼동",
      "property_type": "아파트",
      "exclusive_area": 84.5,
      "households": 500,
      "building_age": 15,
      "kb_lower_price": 800000000,
      "kb_standard_price": 900000000,
      "kb_upper_price": 1000000000,
      "latest_transaction_price": 950000000
    }
  ]
}
```

### 3.2 Add Property

```http
POST /properties
Authorization: Bearer {session_token}
Content-Type: application/json

{
  "address_full": "서울특별시 강남구 역삼동 123-45",
  "sido": "서울특별시",
  "sigungu": "강남구",
  "dong": "역삼동",
  "detail_address": "101동 1001호",
  "property_type": "아파트",
  "exclusive_area": 84.5,
  "households": 500,
  "building_age": 15,
  "kb_lower_price": 800000000,
  "kb_standard_price": 900000000,
  "kb_upper_price": 1000000000,
  "latest_transaction_price": 950000000
}
```

**Response** (201 Created):

```json
{
  "success": true,
  "property": {
    "id": 1,
    // ... full property data
  }
}
```

### 3.3 Get Property Details

```http
GET /properties/{property_id}
Authorization: Bearer {session_token}
```

**Response** (200 OK):

```json
{
  "property": {
    "id": 1,
    // ... property details
  },
  "existing_mortgages": [
    {
      "id": 1,
      "property_id": 1,
      "creditor": "KB국민은행",
      "mortgage_amount": 300000000,
      "remaining_balance": 250000000,
      "mortgage_type": "가계",
      "registration_date": "2020-01-15",
      "maturity_date": "2030-01-15"
    }
  ]
}
```

### 3.4 Add Existing Mortgage

```http
POST /properties/{property_id}/mortgages
Authorization: Bearer {session_token}
Content-Type: application/json

{
  "creditor": "KB국민은행",
  "mortgage_amount": 300000000,
  "remaining_balance": 250000000,
  "mortgage_type": "가계",
  "registration_date": "2020-01-15",
  "maturity_date": "2030-01-15"
}
```

**Response** (201 Created):

```json
{
  "success": true,
  "mortgage": {
    "id": 1,
    // ... full mortgage data
  }
}
```

---

## 4. Consultations

### 4.1 Request Consultation

```http
POST /consultations/request
Authorization: Bearer {session_token}
Content-Type: application/json

{
  "type": "전화상담", // 전화상담, 채팅상담
  "property_id": 1, // optional
  "message": "대출 상담 요청합니다", // optional
  "preferred_time": "2025-01-03T14:00:00Z" // optional
}
```

**Response** (201 Created):

```json
{
  "success": true,
  "consultation": {
    "id": 1,
    "customer_id": 123,
    "type": "전화상담",
    "status": "상담대기",
    "created_at": "2025-01-02T10:00:00Z"
  }
}
```

### 4.2 List My Consultations

```http
GET /consultations?status=상담중&limit=10&offset=0
Authorization: Bearer {session_token}
```

**Response** (200 OK):

```json
{
  "consultations": [
    {
      "id": 1,
      "type": "전화상담",
      "status": "상담중",
      "consultant": {
        "id": 5,
        "name": "김상담"
      },
      "property": {
        "id": 1,
        "address_full": "서울특별시 강남구..."
      },
      "created_at": "2025-01-02T10:00:00Z",
      "updated_at": "2025-01-02T11:00:00Z"
    }
  ],
  "total": 1,
  "limit": 10,
  "offset": 0
}
```

### 4.3 Get Consultation Details

```http
GET /consultations/{consultation_id}
Authorization: Bearer {session_token}
```

**Response** (200 OK):

```json
{
  "consultation": {
    "id": 1,
    "customer_id": 123,
    "consultant_id": 5,
    "property_id": 1,
    "type": "전화상담",
    "status": "상담중",
    "institution_id": 10,
    "institution_manager": "김담당",
    "created_at": "2025-01-02T10:00:00Z"
  },
  "memos": [
    {
      "id": 1,
      "consultation_id": 1,
      "memo": "초기 상담 완료",
      "created_at": "2025-01-02T11:00:00Z",
      "attachments": []
    }
  ]
}
```

---

## 5. Loan Calculations

### 5.1 Calculate Loan Options

```http
POST /calculations
Authorization: Bearer {session_token}
Content-Type: application/json

{
  "customer_id": 123,
  "property_id": 1
}
```

**Response** (200 OK):

```json
{
  "calculation": {
    "id": 1,
    "customer_id": 123,
    "property_id": 1,
    "calculation_date": "2025-01-02T12:00:00Z",
    "policy_snapshot": {
      "calculation_date": "2025-01-02",
      "region_grade": "1급지"
    }
  },
  "results": [
    {
      "id": 1,
      "financial_product": {
        "id": 10,
        "institution_name": "현대캐피탈",
        "product_name": "가계대출 상품A",
        "loan_type": "가계"
      },
      "is_eligible": true,
      "priority": {
        "ltv": 70,
        "limit": 630000000,
        "rate": 4.5
      },
      "secondary": {
        "ltv": 90,
        "limit": 180000000,
        "rate": 8.5
      },
      "available_amount": 810000000,
      "rejection_reasons": [],
      "calculation_details": {
        "property_value": 900000000,
        "existing_mortgage": 250000000,
        "ltv_calculation": "..."
      }
    }
  ]
}
```

### 5.2 Get Calculation History

```http
GET /calculations?customer_id=123&limit=10
Authorization: Bearer {session_token}
```

**Response** (200 OK):

```json
{
  "calculations": [
    {
      "id": 1,
      "calculation_date": "2025-01-02T12:00:00Z",
      "property_id": 1,
      "results_count": 15
    }
  ],
  "total": 1
}
```

---

